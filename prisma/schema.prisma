// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String    @id @default(cuid())
  email     String    @unique
  password  String
  name      String
  phone     String?   @unique  // جعل رقم الهاتف فريد
  whatsapp  String?
  avatar    String?
  facebookId String?  @unique  // Facebook User ID
  role      UserRole  @default(USER)
  status    UserStatus @default(ACTIVE)
  rating    Float?    @default(0.0)
  verified  Boolean   @default(false)
  lastLoginAt DateTime?
  
  // Shop/Business info
  shopName    String?   // اسم المحل
  shopAddress String?   // عنوان المحل
  shopLicense String?   // رخصة المحل
  businessType String?  // نوع النشاط التجاري
  shopImage   String?   // صورة/شعار المحل
  
  // Permissions for sellers and shop owners
  canManageProducts Boolean @default(false)
  canManageUsers    Boolean @default(false)
  canViewReports    Boolean @default(false)
  canManageOrders   Boolean @default(false)
  canManageShop     Boolean @default(false)
  
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  
  // Relations
  auctions  Auction[]
  bids      Bid[]
  products  Product[]
  sentMessages Message[] @relation("SentMessages")
  receivedMessages Message[] @relation("ReceivedMessages")
  notifications Notification[]
  requests Request[] // المطلوبات التي أضافها المستخدم

  favorites Favorite[]
  reviews Review[] @relation("UserReviews")
  receivedReviews Review[] @relation("ReceivedReviews")
  
  @@map("users")
}

model Product {
  id          String        @id @default(cuid())
  title       String
  description String
  price       Float
  condition   String        @default("جديد")
  
  // نوع المنتج: سيارة كاملة أو قطعة غيار
  productType ProductType   @default(PART)
  category    String        @default("قطع غيار")
  
  // معلومات السيارة (للسيارات الكاملة)
  carBrand    String?       // ماركة السيارة (Ford, Chevrolet, Toyota)
  carModel    String?       // موديل السيارة (Mustang, F-150, Raptor, Corvette, Camaro, Supra)
  carYear     Int?          // سنة الصنع
  kilometers  Int?          // الكيلومترات
  transmission String?      // ناقل الحركة (أوتوماتيك/يدوي)
  fuelType    String?       // نوع الوقود
  color       String?       // اللون
  engineSize  String?       // حجم المحرك
  
  // معلومات الاتصال (بدون اسم البائع)
  contactPhone    String?   // رقم الهاتف للاتصال
  contactWhatsapp String?   // رقم الواتساب
  preferredContact String?  // طرق التواصل المفضلة (JSON)
  showSellerName  Boolean   @default(false) // إخفاء اسم البائع
  
  images      String        // JSON array of image URLs/data
  status      ProductStatus @default(ACTIVE)
  featured    Boolean       @default(false)
  views       Int           @default(0)
  soldPrice   Float?        // سعر البيع النهائي
  soldDate    DateTime?     // تاريخ البيع
  buyerInfo   String?       // معلومات المشتري (JSON)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  
  // Relations
  userId      String
  user        User          @relation(fields: [userId], references: [id])

  favorites   Favorite[]
  reviews     Review[]
  
  @@map("products")
}

model Favorite {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  productId String
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([userId, productId])
  @@map("favorites")
}

model CarBrand {
  id        String      @id @default(cuid())
  name      String      @unique
  slug      String      @unique
  logo      String?
  active    Boolean     @default(true)
  createdAt DateTime    @default(now())
  
  // Relations
  models    CarModel[]
  
  @@map("car_brands")
}

model CarModel {
  id        String      @id @default(cuid())
  name      String
  slug      String
  yearFrom  Int
  yearTo    Int
  active    Boolean     @default(true)
  createdAt DateTime    @default(now())
  
  // Relations
  brandId   String
  brand     CarBrand    @relation(fields: [brandId], references: [id])
  compatibility PartCompatibility[]
  auctions  Auction[]
  
  @@unique([brandId, slug])
  @@map("car_models")
}

model PartCategory {
  id          String    @id @default(cuid())
  name        String    @unique
  nameArabic  String
  slug        String    @unique
  description String?
  icon        String?
  parentId    String?
  parent      PartCategory? @relation("CategoryParent", fields: [parentId], references: [id])
  children    PartCategory[] @relation("CategoryParent")
  active      Boolean   @default(true)
  createdAt   DateTime  @default(now())
  
  // Relations
  parts       Part[]
  
  @@map("part_categories")
}

model Part {
  id           String       @id @default(cuid())
  name         String
  nameArabic   String
  description  String
  partNumber   String?
  condition    PartCondition @default(USED)
  yearFrom     Int?
  yearTo       Int?
  images       String
  active       Boolean      @default(true)
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt
  
  // Relations
  categoryId   String
  category     PartCategory @relation(fields: [categoryId], references: [id])
  
  // Car compatibility
  compatibility PartCompatibility[]
  
  @@map("parts")
}

model PartCompatibility {
  id         String     @id @default(cuid())
  partId     String
  part       Part       @relation(fields: [partId], references: [id], onDelete: Cascade)
  modelId    String
  model      CarModel   @relation(fields: [modelId], references: [id])
  yearFrom   Int?
  yearTo     Int?
  createdAt  DateTime   @default(now())
  
  @@unique([partId, modelId])
  @@map("part_compatibility")
}

model Auction {
  id            String        @id @default(cuid())
  title         String
  description   String
  category      String
  carModel      String
  carYear       Int?
  partNumber    String?
  condition     String        @default("مستعملة")
  startingPrice Float
  reservePrice  Float?
  currentPrice  Float
  buyNowPrice   Float?
  endTime       DateTime
  status        AuctionStatus @default(ACTIVE)
  images        String
  featured      Boolean       @default(false)
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  
  // Relations
  sellerId      String
  seller        User          @relation(fields: [sellerId], references: [id])
  carModelId    String?
  carModelRef   CarModel?     @relation(fields: [carModelId], references: [id])
  bids          Bid[]
  winningBidId  String?       @unique
  winningBid    Bid?          @relation("WinningBid", fields: [winningBidId], references: [id])
  messages      Message[]
  
  @@map("auctions")
}

model Bid {
  id        String    @id @default(cuid())
  amount    Float
  createdAt DateTime  @default(now())
  
  // Relations
  bidderId  String
  bidder    User      @relation(fields: [bidderId], references: [id])
  auctionId String
  auction   Auction   @relation(fields: [auctionId], references: [id])
  
  // Winning bid relation
  wonAuction Auction? @relation("WinningBid")
  
  @@map("bids")
}

model Notification {
  id        String             @id @default(cuid())
  type      NotificationType
  title     String
  message   String
  read      Boolean            @default(false)
  data      Json?
  createdAt DateTime           @default(now())
  
  // Relations
  userId    String
  user      User               @relation(fields: [userId], references: [id])
  
  @@map("notifications")
}

model Message {
  id        String      @id @default(cuid())
  content   String
  type      MessageType @default(TEXT)
  read      Boolean     @default(false)
  createdAt DateTime    @default(now())
  
  // Relations
  senderId    String
  sender      User      @relation("SentMessages", fields: [senderId], references: [id])
  receiverId  String
  receiver    User      @relation("ReceivedMessages", fields: [receiverId], references: [id])
  auctionId   String?
  auction     Auction?  @relation(fields: [auctionId], references: [id])
  
  @@map("messages")
}

model Advertisement {
  id          String    @id @default(cuid())
  title       String
  description String
  imageUrl    String?
  link        String?
  active      Boolean   @default(true)
  position    String    @default("header")
  clickCount  Int       @default(0)
  startDate   DateTime?  // تاريخ البداية
  endDate     DateTime?  // تاريخ الانتهاء
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  @@map("advertisements")
}

model Request {
  id          String        @id @default(cuid())
  title       String        // عنوان المطلوب
  description String        // وصف المطلوب
  category    String        @default("قطع غيار") // نوع المطلوب
  carBrand    String?       // ماركة السيارة
  carModel    String?       // موديل السيارة
  carYear     Int?          // سنة الصنع
  image       String?       // (Legacy) صورة توضيحية - لم تعد مستخدمة في التطبيق
  partName    String?       // اسم القطعة المطلوبة
  condition   String?       // الحالة المطلوبة (جديد/مستعمل)
  budget      Float?        // الميزانية المتوقعة
  urgent      Boolean       @default(false) // هل الطلب عاجل
  contactPhone String?      // رقم التواصل
  contactWhatsapp String?   // واتساب
  status      RequestStatus @default(ACTIVE)
  responseCount Int         @default(0) // عدد الردود
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  expiresAt   DateTime?     // تاريخ انتهاء الطلب
  
  // Relations
  userId      String
  user        User          @relation(fields: [userId], references: [id])
  
  @@map("requests")
}

// App-wide settings are stored in a single-row table created/updated by src/lib/appSettings.ts
// We model it here to prevent Prisma db push from trying to drop the table in production.
model AppSettings {
  id              Int      @id
  autoApprove     Boolean  @default(false)
  maintenanceMode Boolean  @default(false)
  allowRegistrations Boolean @default(true)
  maxProductsPerUser Int   @default(10)
  updatedAt       DateTime @default(now())

  @@map("app_settings")
}

enum UserStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
  BANNED
}

enum ProductStatus {
  ACTIVE
  SOLD
  INACTIVE
  DELETED
}

enum ProductType {
  CAR         // سيارة كاملة
  PART        // قطعة غيار
}

enum MessageType {
  TEXT
  SYSTEM
  BID_NOTIFICATION
  AUCTION_UPDATE
}

enum UserRole {
  USER
  SELLER
  SHOP_OWNER
  ADMIN
}

enum PartCondition {
  NEW                 // جديد
  USED                // مستعمل
  USED_NEEDS_REPAIR   // مستعمل يحتاج تصليح
  SCRAP               // سكراب
}

enum AuctionStatus {
  DRAFT
  ACTIVE
  ENDED
  CANCELLED
}

enum NotificationType {
  BID_PLACED
  BID_OUTBID
  AUCTION_WON
  AUCTION_ENDED
  AUCTION_STARTING
  PASSWORD_RESET
  ACCOUNT_VERIFIED
}

enum RequestStatus {
  ACTIVE      // نشط
  FULFILLED   // تم تلبيته
  EXPIRED     // منتهي
  CANCELLED   // ملغي
}

model Review {
  id        String   @id @default(cuid())
  rating    Int      // 1-5 stars
  comment   String?
  type      ReviewType @default(PRODUCT) // نوع التقييم
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relations
  userId    String
  user      User     @relation("UserReviews", fields: [userId], references: [id], onDelete: Cascade)
  
  productId String?
  product   Product? @relation(fields: [productId], references: [id], onDelete: Cascade)
  
  reviewedUserId String? // للتقييمات على البائعين
  reviewedUser   User?   @relation("ReceivedReviews", fields: [reviewedUserId], references: [id], onDelete: Cascade)
  
  @@map("reviews")
}

enum ReviewType {
  PRODUCT  // تقييم منتج
  SELLER   // تقييم بائع
}